<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBTC Aave Position Modeler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        input:focus { outline: none; ring: 2px solid #3b82f6; }
        button { transition: all 0.3s ease; }
        button:hover { transform: translateY(-1px); }
        .metric-label { @apply text-gray-600 font-medium; }
        .metric-value { @apply text-gray-800; }
        .hf-safe { @apply text-green-600; }
        .hf-warning { @apply text-orange-600; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="max-w-2xl w-full bg-white rounded-lg shadow-lg p-6 fade-in">
        <h1 class="text-2xl font-bold text-gray-800 text-center mb-6">Aave WBTC/USDT Position Modeler</h1>
        
        <div class="space-y-6">
            <!-- Ethereum Section -->
            <div class="border border-gray-200 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Ethereum Chain</h2>
                <div class="space-y-3">
                    <div>
                        <label for="eth-supply" class="block text-sm font-medium text-gray-600">WBTC Supplied</label>
                        <input type="number" id="eth-supply" value="0" step="0.0001" min="0" onfocus="if(this.value==='0')this.value=''" onblur="if(this.value==='')this.value='0'" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="eth-borrow" class="block text-sm font-medium text-gray-600">USDT Borrowed</label>
                        <input type="number" id="eth-borrow" value="0" step="0.01" min="0" onfocus="if(this.value==='0')this.value=''" onblur="if(this.value==='')this.value='0'" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="eth-lt" class="block text-sm font-medium text-gray-600">Liquidation Threshold (default 0.825)</label>
                        <input type="number" id="eth-lt" value="0.825" step="0.001" min="0" max="1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>
            
            <!-- Optimism Section -->
            <div class="border border-gray-200 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Optimism Chain</h2>
                <div class="space-y-3">
                    <div>
                        <label for="op-supply" class="block text-sm font-medium text-gray-600">WBTC Supplied</label>
                        <input type="number" id="op-supply" value="0" step="0.0001" min="0" onfocus="if(this.value==='0')this.value=''" onblur="if(this.value==='')this.value='0'" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="op-borrow" class="block text-sm font-medium text-gray-600">USDT Borrowed</label>
                        <input type="number" id="op-borrow" value="0" step="0.01" min="0" onfocus="if(this.value==='0')this.value=''" onblur="if(this.value==='')this.value='0'" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="op-lt" class="block text-sm font-medium text-gray-600">Liquidation Threshold (default 0.80)</label>
                        <input type="number" id="op-lt" value="0.80" step="0.001" min="0" max="1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>
            
            <!-- Settings Section -->
            <div class="border border-gray-200 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Settings</h2>
                <div class="space-y-3">
                    <div>
                        <label for="safety-margin" class="block text-sm font-medium text-gray-600">Safety Margin % (e.g., 8 for HF > 1.08)</label>
                        <input type="number" id="safety-margin" value="8" step="0.1" min="0" max="50" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Adjusts LT for conservative estimates (ignores interest).</p>
                    </div>
                    <div>
                        <label for="current-price" class="block text-sm font-medium text-gray-600">Current WBTC Price in USD (optional, auto-fetched if blank)</label>
                        <input type="number" id="current-price" placeholder="Fetch automatically" step="0.01" min="0" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button onclick="calculate()" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600">Calculate Position Metrics</button>
                </div>
            </div>
            
            <!-- Results Section -->
            <div id="results" class="border border-gray-200 rounded-lg p-4 hidden">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Results</h2>
            </div>
        </div>
    </div>

    <script>
        async function fetchWbtcPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=wrapped-bitcoin&vs_currencies=usd');
                const data = await response.json();
                return data['wrapped-bitcoin'].usd;
            } catch (error) {
                console.error('Error fetching price:', error);
                return null;
            }
        }

        function calculateSaferLt(originalLt, safetyMargin) {
            return originalLt * (1 - safetyMargin / 100);
        }

        function calculateHealthFactor(collateralValue, lt, borrowValue) {
            if (borrowValue === 0) return Infinity;
            return (collateralValue * lt) / borrowValue;
        }

        function calculateLeverage(borrowValue, collateralValue) {
            if (collateralValue === 0) return 0;
            return (borrowValue / collateralValue) * 100;
        }

        async function calculate() {
            const ethSupply = parseFloat(document.getElementById('eth-supply').value) || 0;
            const ethBorrow = parseFloat(document.getElementById('eth-borrow').value) || 0;
            const ethLt = parseFloat(document.getElementById('eth-lt').value) || 0.825;
            
            const opSupply = parseFloat(document.getElementById('op-supply').value) || 0;
            const opBorrow = parseFloat(document.getElementById('op-borrow').value) || 0;
            const opLt = parseFloat(document.getElementById('op-lt').value) || 0.80;
            
            const safetyMargin = parseFloat(document.getElementById('safety-margin').value) || 8;
            const saferLtMultiplier = 1 - safetyMargin / 100;
            
            let currentPrice = parseFloat(document.getElementById('current-price').value);
            if (!currentPrice) {
                currentPrice = await fetchWbtcPrice();
                if (!currentPrice) {
                    alert('Failed to fetch current WBTC price. Please enter manually.');
                    return;
                }
            }

            let resultsHtml = `<h3 class="text-lg font-semibold text-gray-700 mb-4">Results (Safety Margin: ${safetyMargin}%)</h3>`;
            
            // Ethereum Position
            if (ethSupply > 0 && ethBorrow > 0) {
                const ethCollateralValue = ethSupply * currentPrice;
                const ethLiqPrice = ethBorrow / (ethSupply * ethLt);
                const ethSaferLt = ethLt * saferLtMultiplier;
                const ethSaferLiqPrice = ethBorrow / (ethSupply * ethSaferLt);
                const ethHf = calculateHealthFactor(ethCollateralValue, ethLt, ethBorrow);
                const ethSaferHf = calculateHealthFactor(ethCollateralValue, ethSaferLt, ethBorrow);
                const ethLeverage = calculateLeverage(ethBorrow, ethCollateralValue);
                const ethDistance = ((currentPrice - ethLiqPrice) / currentPrice) * 100;
                const ethSaferDistance = ((currentPrice - ethSaferLiqPrice) / currentPrice) * 100;
                const ethHfClass = ethHf >= 1.3 ? 'hf-safe' : 'hf-warning';
                const ethSaferHfClass = ethSaferHf >= 1.3 ? 'hf-safe' : 'hf-warning';
                resultsHtml += `
                    <div class="mb-4 grid grid-cols-1 sm:grid-cols-2 gap-4 bg-gray-50 p-3 rounded-md">
                        <strong class="text-gray-800 col-span-full">Ethereum</strong>
                        <div><span class="metric-label">Supplied WBTC:</span> <span class="metric-value">${ethSupply.toFixed(4)}</span></div>
                        <div><span class="metric-label">Borrowed USDT:</span> <span class="metric-value">${ethBorrow.toFixed(2)}</span></div>
                        <div><span class="metric-label">Base LT | Safer LT:</span> <span class="metric-value">${(ethLt * 100).toFixed(1)}% | ${(ethSaferLt * 100).toFixed(1)}%</span></div>
                        <div><span class="metric-label">Leverage:</span> <span class="metric-value">${ethLeverage.toFixed(2)}%</span></div>
                        <div><span class="metric-label">Base Liq. Price:</span> <span class="metric-value">$${ethLiqPrice.toFixed(2)}</span></div>
                        <div><span class="metric-label">Safer Liq. Price:</span> <span class="metric-value">$${ethSaferLiqPrice.toFixed(2)}</span></div>
                        <div><span class="metric-label">Current Price:</span> <span class="metric-value">$${currentPrice.toFixed(2)}</span></div>
                        <div><span class="metric-label">Base HF | Safer HF:</span> <span class="metric-value ${ethHfClass}">${ethHf.toFixed(2)}</span> | <span class="metric-value ${ethSaferHfClass}">${ethSaferHf.toFixed(2)}</span></div>
                        <div><span class="metric-label">Base Distance | Safer:</span> <span class="metric-value">${ethDistance.toFixed(2)}% | ${ethSaferDistance.toFixed(2)}%</span></div>
                    </div>`;
            }
            
            // Optimism Position
            if (opSupply > 0 && opBorrow > 0) {
                const opCollateralValue = opSupply * currentPrice;
                const opLiqPrice = opBorrow / (opSupply * opLt);
                const opSaferLt = opLt * saferLtMultiplier;
                const opSaferLiqPrice = opBorrow / (opSupply * opSaferLt);
                const opHf = calculateHealthFactor(opCollateralValue, opLt, opBorrow);
                const opSaferHf = calculateHealthFactor(opCollateralValue, opSaferLt, opBorrow);
                const opLeverage = calculateLeverage(opBorrow, opCollateralValue);
                const opDistance = ((currentPrice - opLiqPrice) / currentPrice) * 100;
                const opSaferDistance = ((currentPrice - opSaferLiqPrice) / currentPrice) * 100;
                const opHfClass = opHf >= 1.3 ? 'hf-safe' : 'hf-warning';
                const opSaferHfClass = opSaferHf >= 1.3 ? 'hf-safe' : 'hf-warning';
                resultsHtml += `
                    <div class="mb-4 grid grid-cols-1 sm:grid-cols-2 gap-4 bg-gray-50 p-3 rounded-md">
                        <strong class="text-gray-800 col-span-full">Optimism</strong>
                        <div><span class="metric-label">Supplied WBTC:</span> <span class="metric-value">${opSupply.toFixed(4)}</span></div>
                        <div><span class="metric-label">Borrowed USDT:</span> <span class="metric-value">${opBorrow.toFixed(2)}</span></div>
                        <div><span class="metric-label">Base LT | Safer LT:</span> <span class="metric-value">${(opLt * 100).toFixed(1)}% | ${(opSaferLt * 100).toFixed(1)}%</span></div>
                        <div><span class="metric-label">Leverage:</span> <span class="metric-value">${opLeverage.toFixed(2)}%</span></div>
                        <div><span class="metric-label">Base Liq. Price:</span> <span class="metric-value">$${opLiqPrice.toFixed(2)}</span></div>
                        <div><span class="metric-label">Safer Liq. Price:</span> <span class="metric-value">$${opSaferLiqPrice.toFixed(2)}</span></div>
                        <div><span class="metric-label">Current Price:</span> <span class="metric-value">$${currentPrice.toFixed(2)}</span></div>
                        <div><span class="metric-label">Base HF | Safer HF:</span> <span class="metric-value ${opHfClass}">${opHf.toFixed(2)}</span> | <span class="metric-value ${opSaferHfClass}">${opSaferHf.toFixed(2)}</span></div>
                        <div><span class="metric-label">Base Distance | Safer:</span> <span class="metric-value">${opDistance.toFixed(2)}% | ${opSaferDistance.toFixed(2)}%</span></div>
                    </div>`;
            }
            
            // Combined Position
            if (ethSupply > 0 && ethBorrow > 0 && opSupply > 0 && opBorrow > 0) {
                const totalCollateralValue = (ethSupply + opSupply) * currentPrice;
                const weightedLt = ((ethSupply * currentPrice * ethLt) + (opSupply * currentPrice * opLt)) / totalCollateralValue;
                const totalBorrowValue = ethBorrow + opBorrow;
                const combinedHf = calculateHealthFactor(totalCollateralValue, weightedLt, totalBorrowValue);
                const saferWeightedLt = weightedLt * saferLtMultiplier;
                const combinedSaferHf = calculateHealthFactor(totalCollateralValue, saferWeightedLt, totalBorrowValue);
                const combinedLeverage = calculateLeverage(totalBorrowValue, totalCollateralValue);
                const combinedHfClass = combinedHf >= 1.3 ? 'hf-safe' : 'hf-warning';
                const combinedSaferHfClass = combinedSaferHf >= 1.3 ? 'hf-safe' : 'hf-warning';
                resultsHtml += `
                    <div class="mb-4 grid grid-cols-1 sm:grid-cols-2 gap-4 bg-gray-50 p-3 rounded-md">
                        <strong class="text-gray-800 col-span-full">Combined (ETH + OP)</strong>
                        <div><span class="metric-label">Total Supplied WBTC:</span> <span class="metric-value">${(ethSupply + opSupply).toFixed(4)}</span></div>
                        <div><span class="metric-label">Total Borrowed USDT:</span> <span class="metric-value">${(ethBorrow + opBorrow).toFixed(2)}</span></div>
                        <div><span class="metric-label">Weighted LT | Safer:</span> <span class="metric-value">${(weightedLt * 100).toFixed(1)}% | ${(saferWeightedLt * 100).toFixed(1)}%</span></div>
                        <div><span class="metric-label">Combined Leverage:</span> <span class="metric-value">${combinedLeverage.toFixed(2)}%</span></div>
                        <div><span class="metric-label">Combined HF | Safer HF:</span> <span class="metric-value ${combinedHfClass}">${combinedHf.toFixed(2)}</span> | <span class="metric-value ${combinedSaferHfClass}">${combinedSaferHf.toFixed(2)}</span></div>
                    </div>`;
            }
            
            if (resultsHtml === `<h3 class="text-lg font-semibold text-gray-700 mb-4">Results (Safety Margin: ${safetyMargin}%)</h3>`) {
                resultsHtml += '<p class="text-gray-600">Please enter values for at least one chain.</p>';
            }
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = resultsHtml;
            resultsDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>
