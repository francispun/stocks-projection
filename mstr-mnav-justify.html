<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two-Stage mNAV Model</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .slider-container { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; }
        input[type="range"] { width: 100%; }
        .value { font-weight: bold; }
        #result { margin-top: 30px; padding: 15px; background: #f0f0f0; border-radius: 5px; }
        #range { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Two-Stage mNAV Interactive Model</h1>
    <p>Adjust sliders for high-growth phase (n years at g) and terminal phase (perpetual at g_terminal). <br>
    Fair mNAV = 1 + [PV(Stage 1 excesses) + PV(Terminal Value)] / A_0<br>
    Terminal multiple = (1 + g_terminal) / (k - g_terminal) applied to excess_11 if k > g_terminal and g_terminal > c.</p>
    <p>Percentages (e.g., 30 for 30%). If k <= g_terminal or g_terminal <= c, terminal = 0 (invalid).</p>

    <div class="slider-container">
        <label for="g">High-Growth BTC Return (g): <span id="g-value" class="value">30%</span></label>
        <input type="range" id="g" min="0" max="50" value="30" step="1">
    </div>

    <div class="slider-container">
        <label for="c">Cost of Borrowing (c): <span id="c-value" class="value">10%</span></label>
        <input type="range" id="c" min="0" max="20" value="10" step="1">
    </div>

    <div class="slider-container">
        <label for="k">Discount Rate (k): <span id="k-value" class="value">5%</span></label>
        <input type="range" id="k" min="1" max="30" value="5" step="1">
    </div>

    <div class="slider-container">
        <label for="da">Amplification (D/A): <span id="da-value" class="value">30%</span></label>
        <input type="range" id="da" min="0" max="50" value="30" step="1">
    </div>

    <div class="slider-container">
        <label for="n">High-Growth Years (n): <span id="n-value" class="value">10</span></label>
        <input type="range" id="n" min="1" max="50" value="10" step="1">
    </div>

    <div class="slider-container">
        <label for="g_term">Terminal Growth (g_terminal): <span id="g_term-value" class="value">12%</span></label>
        <input type="range" id="g_term" min="0" max="29" value="12" step="1"> <!-- Max < min k to avoid diverge -->
    </div>

    <div id="result">
        <h2>Calculated Fair mNAV: <span id="mnav">1.46</span></h2>
        <p>Premium/Discount: <span id="premium">46%</span></p>
        <p>Implied Terminal Multiple: <span id="multiple">N/A</span></p>
    </div>

    <div id="range">
        <h3>Example Ranges</h3>
        <p>No Terminal (g_term <= c): mNAV ≈1.46 (46% premium)</p>
        <p>With g_term=15%, k=20%: mNAV ≈1.55 (55% premium, multiple~5x)</p>
        <p>Optimistic (g_term=4%, k=5%, c=0): mNAV ≈2.13 (113% premium, multiple~100x)</p>
    </div>

    <script>
        const sliders = {
            g: document.getElementById('g'),
            c: document.getElementById('c'),
            k: document.getElementById('k'),
            da: document.getElementById('da'),
            n: document.getElementById('n'),
            g_term: document.getElementById('g_term')
        };

        const values = {
            g: document.getElementById('g-value'),
            c: document.getElementById('c-value'),
            k: document.getElementById('k-value'),
            da: document.getElementById('da-value'),
            n: document.getElementById('n-value'),
            g_term: document.getElementById('g_term-value')
        };

        function updateValues() {
            Object.keys(sliders).forEach(key => {
                if (key === 'n') {
                    values[key].textContent = sliders[key].value;
                } else {
                    values[key].textContent = `${sliders[key].value}%`;
                }
            });
            calculate();
        }

        function calculate() {
            const g = sliders.g.value / 100;
            const c = sliders.c.value / 100;
            const k = sliders.k.value / 100;
            const da = sliders.da.value / 100;
            const n = parseInt(sliders.n.value);
            const g_term = sliders.g_term.value / 100;

            if (k === 0) {
                mnavDisplay.textContent = 'Invalid (k=0)';
                premiumDisplay.textContent = 'N/A';
                multipleDisplay.textContent = 'N/A';
                return;
            }

            // Stage 1: Finite annuity for high-growth
            const excess_high = g - c;
            const annuityFactor = (1 - Math.pow(1 + k, -n)) / k;
            const stage1_multiplier = excess_high * annuityFactor;
            let premium = stage1_multiplier * da;

            // Stage 2: Terminal at end of n
            let multiple = 'N/A';
            if (g_term > c && k > g_term) {
                const excess_term = g_term - c;
                const growth_factor = Math.pow(1 + g, n); // A_n / A_0
                const excess_11 = excess_term * da * growth_factor * (1 + g_term);
                const term_multiple = 1 / (k - g_term);
                multiple = term_multiple.toFixed(1) + 'x';
                const term_value = excess_11 * term_multiple;
                const pv_term = term_value / Math.pow(1 + k, n);
                premium += pv_term; // Corrected normalization: pv_term is already / A_0 scale
            }

            const mnav = (1 + premium).toFixed(2);
            const prem_pct = (premium * 100).toFixed(0);

            mnavDisplay.textContent = mnav;
            premiumDisplay.textContent = prem_pct >= 0 ? `${prem_pct}% premium` : `${Math.abs(prem_pct)}% discount`;
            multipleDisplay.textContent = multiple;
        }

        const mnavDisplay = document.getElementById('mnav');
        const premiumDisplay = document.getElementById('premium');
        const multipleDisplay = document.getElementById('multiple');

        Object.values(sliders).forEach(slider => {
            slider.addEventListener('input', updateValues);
        });

        updateValues(); // Initial update
    </script>

    <p>To use: Save as .html and open in browser. Set g_term > c for terminal to activate.</p>
</body>
</html>
